import { describe, expect } from 'vitest';
import { getLoadBarNext } from './getLoadBarNext';
import { nameof } from '@/utils/type/nameof';

describe(nameof({ getLoadBarNext }), (it) => {
	it('should grow from 0 to augmented', () => {
		expect(createLoadBarReport([{ target: 0, t: 0 }]))
			.toMatchInlineSnapshot(`
				{
				  "duration": 21800,
				  "sequence": [
				    0.006666666666666667,
				    0.0132,
				    0.019602666666666668,
				    0.025877280000000003,
				    0.03202640106666667,
				    0.038052539712000004,
				    0.04395815558442667,
				    0.049745659139404805,
				    0.055417412623283376,
				    0.060975731037484375,
				    0.06642288308340136,
				    0.0717610920884,
				    0.07699253691329866,
				    0.08211935284169936,
				    0.08714363245153203,
				    0.09206742646916806,
				    0.09689274460645136,
				    0.101621556380989,
				    0.1062557919200359,
				    0.11079734274830184,
				    0.11524806256000247,
				    0.11960976797546909,
				    0.12388423928262637,
				    0.1280732211636405,
				    0.13217842340703437,
				    0.13620152160556034,
				    0.1401441578401158,
				    0.14400794134998016,
				    0.1477944491896472,
				    0.15150522687252094,
				    0.1551417890017372,
				    0.15870561988836912,
				    0.1621981741572684,
				    0.1656208773407897,
				    0.16897512646064058,
				    0.17226229059809445,
				    0.17548371145279923,
				    0.17864070389040992,
				    0.1817345564792684,
				    0.18476653201634968,
				    0.18773786804268935,
				    0.19064977734850225,
				    0.19350344846819886,
				    0.19630004616550156,
				    0.1990407119088582,
				    0.2017265643373477,
				    0.20435869971726742,
				    0.20693819238958874,
				    0.20946609520846363,
				    0.21194343997096102,
				    0.21437123783820847,
				    0.21675047974811096,
				    0.2190821368198154,
				    0.22136716075008575,
				    0.2236064842017507,
				    0.22580102118438233,
				    0.22795166742736137,
				    0.2300593007454808,
				    0.23212478139723786,
				    0.23414895243595976,
				    0.23613264005390724,
				    0.23807665391949576,
				    0.23998178750777252,
				    0.24184881842428374,
				    0.24367850872246474,
				    0.24547160521468211,
				    0.24722883977705515,
				    0.24895092964818072,
				    0.25063857772188375,
				    0.2522924728341127,
				    0.25391329004409713,
				    0.25550169090988184,
				    0.25705832375835086,
				    0.2585838239498505,
				    0.26007881413752015,
				    0.26154390452143644,
				    0.2629796930976744,
				    0.2643867659023876,
				    0.2657656972510065,
				    0.26711704997265306,
				    0.2684413756398667,
				    0.269739214793736,
				    0.271011097164528,
				    0.2722575418879041,
				    0.27347905771681263,
				    0.274676143229143,
				    0.27584928703122685,
				    0.27699896795726897,
				    0.2781256552647903,
				    0.2792298088261611,
				    0.2803118793163045,
				    0.2813723083966451,
				    0.2824115288953789,
				    0.28342996498413797,
				    0.2844280323511219,
				    0.2854061383707661,
				    0.28636468227001743,
				    0.2873040552912838,
				    0.2882246408521248,
				    0.28912681470174895,
				    0.29001094507438063,
				    0.2908773928395597,
				    0.2917265116494352,
				    0.29255864808311316,
				    0.29337414178811755,
				    0.2941733256190219,
				    0.2949565257733081,
				    0.2957240619245086,
				    0.29647624735268513,
				    0.2972133890722981,
				    0.2979357879575188,
				    0.2986437388650351,
				    0.29933753075440106,
				    0.3000174468059797,
				    0.3006837645365268,
				    0.3013367559124629,
				    0.3019766874608803,
				    0.30260382037832934,
				    0.30321841063742944,
				    0.3038207090913475,
				    0.30441096157618724,
				    0.30498940901133015,
				    0.3055562874977702,
				    0.3061118284144815,
				    0.3066562585128585,
				    0.307189800009268,
				    0.3077126706757493,
				    0.30822508392890097,
				    0.3087272489169896,
				    0.30921937060531646,
				    0.3097016498598768,
				    0.31017428352934595,
				    0.3106374645254257,
				    0.3110913819015838,
				    0.3115362209302188,
				    0.31197216317828114,
				    0.31239938658138217,
				    0.31281806551642116,
				    0.3132283708727594,
				    0.3136304701219709,
				    0.3140245273861981,
				    0.31441070350514083,
				    0.31478915610170466,
				    0.3151600396463372,
				    0.31552350552007713,
				    0.31587970207634225,
				    0.3162287747014821,
				    0.3165708658741191,
				    0.31690611522330336,
				    0.31723465958550395,
				    0.31755663306046056,
				    0.31787216706591803,
				    0.31818139039126636,
				    0.3184844292501077,
				    0.31878140733177224,
				    0.31907244585180344,
				    0.319357663601434,
				    0.319637176996072,
				    0.31991110012281726,
				    0.3201795447870276,
				    0.3204426205579537,
				    0.3207004348134613,
				    0.3209530927838587,
				    0.3212006975948482,
				    0.3214433503096179,
				    0.32168114997009223,
				    0.32191419363735707,
				    0.3221425764312766,
				    0.32236639156931773,
				    0.32258573040459804,
				    0.32280068246317273,
				    0.3230113354805759,
				    0.3232177754376311,
				    0.3234200865955451,
				    0.3236183515303009,
				    0.32381265116636154,
				    0.324003064809701,
				    0.32418967018017364,
				    0.32437254344323685,
				    0.3245517592410388,
				    0.3247273907228847,
				    0.32489950957509367,
				    0.32506818605025845,
				    0.3252334889959199,
				    0.3253954858826682,
				    0.3255542428316815,
				    0.32570982464171455,
				    0.3258622948155469,
				    0.32601171558590264,
				    0.32615814794085124,
				    0.3263016516487009,
				    0.32644228528239355,
				    0.3265801062434123,
				    0.32671517078521073,
				    0.32684753403617317,
				    0.32697725002211636,
				    0.3271043716883407,
				    0.3272289509212406,
				    0.32735103856948244,
				    0.32747068446475947,
				    0.32758793744213094,
				    0.327702845359955,
				    0.32781545511942256,
				    0.3279258126837008,
				    0.32803396309669347,
				    0.32813995050142625,
				    0.3282438181580644,
				    0.3283456084615698,
				    0.32844536295900506,
				    0.32854312236649164,
				    0.3286389265858285,
				    0.3287328147207786,
				    0.3288248250930297,
				    0.32891499525783574,
				    0.3290033620193457,
				    0.32908996144562547,
				    0.3291748288833796,
				    0.3292579989723787,
				    0.32933950565959774,
				  ],
				}
			`);
	});

	it('should grow from 0 to 0.5 to augmented', () => {
		expect(createLoadBarReport([{ target: 0.5, t: 0 }]))
			.toMatchInlineSnapshot(`
				{
				  "duration": 20500,
				  "sequence": [
				    0.05333333333333334,
				    0.10133333333333333,
				    0.14453333333333335,
				    0.18341333333333334,
				    0.21840533333333334,
				    0.24989813333333333,
				    0.27824165333333334,
				    0.3037508213333333,
				    0.3267090725333333,
				    0.34737149861333333,
				    0.3659676820853333,
				    0.3827042472101333,
				    0.3977671558224533,
				    0.41132377357354133,
				    0.42352472954952053,
				    0.43450558992790184,
				    0.44438836426844497,
				    0.4532828611749338,
				    0.46128790839077377,
				    0.4684924508850297,
				    0.4749765391298601,
				    0.48081221855020745,
				    0.48606433002852006,
				    0.4907912303590014,
				    0.4950454406564346,
				    0.49887422992412445,
				    0.5023201402650453,
				    0.5056070707930778,
				    0.5088282627105496,
				    0.511985030789672,
				    0.5150786635072119,
				    0.5181104235704009,
				    0.5210815484323262,
				    0.5239932507970131,
				    0.5268467191144062,
				    0.5296431180654514,
				    0.5323835890374757,
				    0.5350692505900596,
				    0.5377011989115917,
				    0.5402805082666933,
				    0.5428082314346927,
				    0.5452854001393321,
				    0.5477130254698789,
				    0.5500920982938147,
				    0.5524235896612717,
				    0.5547084512013796,
				    0.5569476155106853,
				    0.5591419965338049,
				    0.5612924899364622,
				    0.5633999734710663,
				    0.5654653073349784,
				    0.5674893345216121,
				    0.5694728811645132,
				    0.5714167568745563,
				    0.5733217550703985,
				    0.5751886533023238,
				    0.5770182135696107,
				    0.5788111826315518,
				    0.5805682923122542,
				    0.5822902597993425,
				    0.583977787936689,
				    0.5856315655112885,
				    0.5872522675343961,
				    0.5888405555170415,
				    0.590397077740034,
				    0.5919224695185666,
				    0.5934173534615287,
				    0.5948823397256314,
				    0.5963180262644522,
				    0.5977249990724964,
				    0.5991038324243798,
				    0.6004550891092255,
				    0.6017793206603743,
				    0.6030770675805002,
				    0.6043488595622235,
				    0.6055952157043124,
				    0.6068166447235595,
				    0.6080136451624216,
				    0.6091867055925065,
				    0.6103363048139897,
				    0.6114629120510432,
				    0.6125669871433557,
				    0.6136489807338219,
				    0.6147093344524788,
				    0.6157484810967625,
				    0.6167668448081606,
				    0.6177648412453307,
				    0.6187428777537575,
				    0.6197013535320156,
				    0.6206406597947086,
				    0.6215611799321478,
				    0.6224632896668382,
				    0.6233473572068348,
				    0.6242137433960314,
				    0.6250628018614441,
				    0.6258948791575486,
				    0.626710314907731,
				    0.6275094419429097,
				    0.6282925864373848,
				    0.6290600680419705,
				    0.6298122000144644,
				    0.6305492893475084,
				    0.6312716368938915,
				    0.6319795374893471,
				    0.6326732800728935,
				    0.6333531478047689,
				    0.6340194181820069,
				    0.6346723631517001,
				    0.6353122492219994,
				    0.6359393375708927,
				    0.6365538841528082,
				    0.6371561398030854,
				    0.637746350340357,
				    0.6383247566668832,
				    0.6388915948668789,
				    0.6394470963028747,
				    0.6399914877101505,
				    0.6405249912892808,
				    0.6410478247968284,
				    0.6415602016342252,
				    0.6420623309348741,
				    0.6425544176495099,
				    0.643036662629853,
				    0.6435092627105893,
				    0.6439724107897108,
				    0.6444262959072499,
				    0.6448711033224382,
				    0.6453070145893228,
				    0.6457342076308697,
				    0.6461528568115857,
				    0.6465631330086874,
				    0.646965203681847,
				    0.6473592329415434,
				    0.6477453816160459,
				    0.6481238073170583,
				    0.6484946645040505,
				    0.6488581045473027,
				    0.64921427578969,
				    0.6495633236072296,
				    0.6499053904684183,
				    0.6502406159923833,
				    0.6505691370058689,
				    0.6508910875990849,
				    0.6512065991804366,
				    0.6515158005301611,
				    0.6518188178528912,
				    0.6521157748291667,
				    0.6524067926659167,
				    0.6526919901459317,
				    0.6529714836763464,
				    0.6532453873361528,
				    0.6535138129227631,
				    0.6537768699976412,
				    0.6540346659310217,
				    0.6542873059457346,
				    0.6545348931601532,
				    0.6547775286302835,
				    0.6550153113910111,
				    0.6552483384965242,
				    0.6554767050599271,
				    0.6557005042920618,
				    0.6559198275395539,
				    0.6561347643220962,
				    0.6563454023689875,
				    0.6565518276549411,
				    0.6567541244351757,
				    0.6569523752798054,
				    0.6571466611075426,
				    0.657337061218725,
				    0.6575236533276839,
				    0.6577065135944635,
				    0.6578857166559076,
				    0.6580613356561228,
				    0.6582334422763336,
				    0.6584021067641402,
				    0.6585673979621908,
				    0.6587293833362803,
				    0.658888129002888,
				    0.6590436997561635,
				    0.6591961590943736,
				    0.6593455692458194,
				    0.6594919911942364,
				    0.659635484703685,
				    0.6597761083429446,
				    0.6599139195094191,
				    0.660048974452564,
				    0.6601813282968461,
				    0.6603110350642425,
				    0.660438147696291,
				    0.6605627180756984,
				    0.6606847970475178,
				    0.6608044344399008,
				    0.6609216790844361,
				    0.6610365788360807,
				    0.6611491805926925,
				    0.661259530314172,
				    0.6613676730412218,
				    0.6614736529137307,
				    0.6615775131887894,
				    0.661679296258347,
				    0.6617790436665134,
				    0.6618767961265165,
				    0.6619725935373195,
				    0.6620664749999065,
				    0.6621584788332416,
				    0.6622486425899101,
				  ],
				}
			`);
	});

	it('should grow from 0 to 0.5 to 0.75 to augmented', () => {
		expect(
			createLoadBarReport([
				{ target: 0.5, t: 0 },
				{ target: 0.75, t: 8000 },
			]),
		).toMatchInlineSnapshot(`
			{
			  "duration": 24600,
			  "sequence": [
			    0.05333333333333334,
			    0.10133333333333333,
			    0.14453333333333335,
			    0.18341333333333334,
			    0.21840533333333334,
			    0.24989813333333333,
			    0.27824165333333334,
			    0.3037508213333333,
			    0.3267090725333333,
			    0.34737149861333333,
			    0.3659676820853333,
			    0.3827042472101333,
			    0.3977671558224533,
			    0.41132377357354133,
			    0.42352472954952053,
			    0.43450558992790184,
			    0.44438836426844497,
			    0.4532828611749338,
			    0.46128790839077377,
			    0.4684924508850297,
			    0.4749765391298601,
			    0.48081221855020745,
			    0.48606433002852006,
			    0.4907912303590014,
			    0.4950454406564346,
			    0.49887422992412445,
			    0.5023201402650453,
			    0.5056070707930778,
			    0.5088282627105496,
			    0.511985030789672,
			    0.5150786635072119,
			    0.5181104235704009,
			    0.5210815484323262,
			    0.5239932507970131,
			    0.5268467191144062,
			    0.5296431180654514,
			    0.5323835890374757,
			    0.5350692505900596,
			    0.5377011989115917,
			    0.5402805082666933,
			    0.5428082314346927,
			    0.5452854001393321,
			    0.5477130254698789,
			    0.5500920982938147,
			    0.5524235896612717,
			    0.5547084512013796,
			    0.5569476155106853,
			    0.5591419965338049,
			    0.5612924899364622,
			    0.5633999734710663,
			    0.5654653073349784,
			    0.5674893345216121,
			    0.5694728811645132,
			    0.5714167568745563,
			    0.5733217550703985,
			    0.5751886533023238,
			    0.5770182135696107,
			    0.5788111826315518,
			    0.5805682923122542,
			    0.5822902597993425,
			    0.583977787936689,
			    0.5856315655112885,
			    0.5872522675343961,
			    0.5888405555170415,
			    0.590397077740034,
			    0.5919224695185666,
			    0.5934173534615287,
			    0.5948823397256314,
			    0.5963180262644522,
			    0.5977249990724964,
			    0.5991038324243798,
			    0.6004550891092255,
			    0.6017793206603743,
			    0.6030770675805002,
			    0.6043488595622235,
			    0.6055952157043124,
			    0.6068166447235595,
			    0.6080136451624216,
			    0.6091867055925065,
			    0.6103363048139897,
			    0.6259693409992574,
			    0.6400390735659983,
			    0.6527018328760652,
			    0.6640983162551254,
			    0.6743551512962795,
			    0.6835863028333182,
			    0.6918943392166531,
			    0.6993715719616544,
			    0.7061010814321557,
			    0.7121576399556068,
			    0.7176085426267128,
			    0.7225143550307082,
			    0.726929586194304,
			    0.7309032942415403,
			    0.7344796314840529,
			    0.7376983350023143,
			    0.7405951681687495,
			    0.7432023180185412,
			    0.7455487528833538,
			    0.747660544261685,
			    0.7495611565021832,
			    0.7512717075186316,
			    0.7529129400349256,
			    0.7545213479008938,
			    0.7560975876095426,
			    0.7576423025240184,
			    0.7591561231402048,
			    0.7606396673440673,
			    0.7620935406638526,
			    0.7635183365172422,
			    0.7649146364535641,
			    0.7662830103911594,
			    0.7676240168500029,
			    0.7689382031796695,
			    0.7702261057827429,
			    0.7714882503337547,
			    0.7727251519937463,
			    0.773937315620538,
			    0.7751252359747939,
			    0.7762893979219647,
			    0.777430276630192,
			    0.7785483377642549,
			    0.7796440376756365,
			    0.7807178235887905,
			    0.7817701337836813,
			    0.7828013977746744,
			    0.7838120364858475,
			    0.7848024624227973,
			    0.785773079841008,
			    0.7867242849108544,
			    0.787656465879304,
			    0.7885700032283847,
			    0.7894652698304836,
			    0.7903426311005406,
			    0.7912024451451964,
			    0.7920450629089592,
			    0.7928708283174466,
			    0.7936800784177643,
			    0.7944731435160757,
			    0.7952503473124208,
			    0.796012007032839,
			    0.7967584335588489,
			    0.7974899315543386,
			    0.7982067995899185,
			    0.7989093302647867,
			    0.7995978103261576,
			    0.8002725207863012,
			    0.8009337370372418,
			    0.8015817289631636,
			    0.8022167610505669,
			    0.8028390924962223,
			    0.8034489773129645,
			    0.8040466644333719,
			    0.8046323978113712,
			    0.8052064165218105,
			    0.8057689548580409,
			    0.8063202424275467,
			    0.8068605042456625,
			    0.8073899608274159,
			    0.8079088282775342,
			    0.8084173183786502,
			    0.8089156386777439,
			    0.8094039925708556,
			    0.8098825793861052,
			    0.8103515944650498,
			    0.8108112292424154,
			    0.8112616713242338,
			    0.8117031045644157,
			    0.812135709139794,
			    0.8125596616236649,
			    0.8129751350578582,
			    0.8133822990233678,
			    0.8137813197095671,
			    0.8141723599820424,
			    0.8145555794490682,
			    0.8149311345267535,
			    0.815299178502885,
			    0.815659861599494,
			    0.8160133310341707,
			    0.816359731080154,
			    0.8166992031252176,
			    0.8170318857293799,
			    0.817357914681459,
			    0.8176774230544965,
			    0.8179905412600733,
			    0.8182973971015385,
			    0.8185981158261744,
			    0.8188928201763176,
			    0.8191816304394579,
			    0.8194646644973355,
			    0.8197420378740554,
			    0.8200138637832409,
			    0.8202802531742428,
			    0.8205413147774246,
			    0.8207971551485428,
			    0.8210478787122386,
			    0.8212935878046606,
			    0.821534382715234,
			    0.821770361727596,
			    0.8220016211597108,
			    0.8222282554031832,
			    0.8224503569617863,
			    0.8226680164892172,
			    0.8228813228260995,
			    0.8230903630362442,
			    0.823295222442186,
			    0.823495984660009,
			    0.8236927316334755,
			    0.8238855436674726,
			    0.8240744994607898,
			    0.8242596761382407,
			    0.8244411492821425,
			    0.8246189929631663,
			    0.8247932797705697,
			    0.8249640808418249,
			    0.8251314658916551,
			    0.8252955032404886,
			    0.8254562598423455,
			    0.8256138013121652,
			    0.8257681919525885,
			    0.8259194947802034,
			    0.826067771551266,
			    0.8262130827869073,
			    0.8263554877978359,
			    0.8264950447085458,
			    0.8266318104810416,
			    0.8267658409380875,
			    0.8268971907859924,
			    0.8270259136369392,
			    0.8271520620308671,
			    0.8272756874569165,
			    0.8273968403744448,
			    0.8275155702336227,
			    0.8276319254956168,
			    0.8277459536523711,
			    0.8278577012459903,
			    0.8279672138877372,
			    0.8280745362766491,
			    0.8281797122177827,
			    0.8282827846400937,
			    0.8283837956139586,
			    0.828482786368346,
			    0.8285797973076457,
			    0.8286748680281595,
			    0.828768037334263,
			    0.8288593432542444,
			    0.8289488230558262,
			  ],
			}
		`);
	});
});

function createLoadBarReport(
	keyframes: {
		target: number;
		t: number;
	}[],
	deltaT = 1000 / 10,
) {
	const sequence = createLoadBarSequence(keyframes, deltaT);
	return {
		duration: (sequence.length - 1) * deltaT,
		sequence,
	};
}

function createLoadBarSequence(
	keyframes: {
		target: number;
		t: number;
	}[],
	deltaT = 1000 / 10,
) {
	const sequence: number[] = [];

	let t = 0;
	let curr = 0;
	for (;;) {
		// eslint-disable-next-line @typescript-eslint/no-loop-func
		const keyframe = keyframes.findLast((keyframe) => t >= keyframe.t);
		if (!keyframe) {
			break;
		}

		const { target } = keyframe;
		const next = getLoadBarNext(target, curr, deltaT);
		sequence.push(next);
		if (curr.toPrecision(4) === next.toPrecision(4)) {
			break;
		}
		curr = next;
		t += deltaT;
	}

	return sequence;
}
